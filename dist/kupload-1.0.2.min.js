/**
 * kupload v1.0.2 - Copyright (c) 2019-2020 Florent VIALATTE
 * Released under the MIT license
 */
"use strict";!function(e){e.fn.kupload=function(o){var n,a=e(this),t=0,r=!1;if(o||(o={}),!o.url)throw"upload URL is mandatory";if(o.maxfiles||(o.maxfiles=1),o.compress||(o.compress=!1),o.compress&&!o.pakoDeflatePath)throw"pakoDeflatePath is mandatory if compress";o.timeout||(o.timeout=0),o.maxfilesize||(o.maxfilesize=20971520),o.resDataType||(o.resDataType=null),o.onDragEnter||(o.onDragEnter=function(){}),o.onDragLeave||(o.onDragLeave=function(){}),o.onNewFiles||(o.onNewFiles=function(){}),o.onFileSizeError||(o.onFileSizeError=function(){}),o.onTooManyFiles||(o.onTooManyFiles=function(){}),o.onBeforeUpload||(o.onBeforeUpload=function(){}),o.onUploadProgress||(o.onUploadProgress=function(){}),o.onUploadComplete||(o.onUploadComplete=function(){}),o.onUploadSuccess||(o.onUploadSuccess=function(){}),o.onUploadError||(o.onUploadError=function(){}),o.onAjaxComplete||(o.onAjaxComplete=function(){}),this.upInProgress=function(){return r};var i,l=function(e){if(r=!0,e.length>o.maxfiles)return o.onTooManyFiles.call(),void(r=!1);o.onNewFiles.call(this,e);var a=[],t=0;for(var i in e)if("object"==typeof e[i]){var l=e[i];if(t+=l.size,l.size>o.maxfilesize||t>o.maxfilesize)return o.onFileSizeError.call(),void(r=!1);a.push(e[i])}o.onBeforeUpload.call(),n.postMessage({compress:o.compress,files:a})},s=function(e){if(void 0!==e&&e.lengthComputable){var n=Math.round(100*e.loaded/e.total);o.onUploadProgress.call(this,n),n>=100&&o.onUploadComplete.call()}},f="'use strict';self.addEventListener('message',e=>{if(e.data.pakoDeflatePath){importScripts(e.data.pakoDeflatePath);return}var files=e.data.files;var compress=e.data.compress;var final_res=[];for(var i in files){var file=files[i];var content;if(file.size<1000)compress=!1;if(compress)content=pako.gzip((new FileReaderSync()).readAsArrayBuffer(file),{level:1});else content=(new FileReaderSync()).readAsArrayBuffer(file);final_res.push({filename:file.name,orig_size:file.size,compressed:compress,content:new Blob([content])})}self.postMessage(final_res)},!1)";try{i=new Blob([f],{type:"application/javascript"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,(i=new BlobBuilder).append(f),i=i.getBlob()}n=new Worker((window.URL||window.webkitURL).createObjectURL(i)),o.compress&&n.postMessage({pakoDeflatePath:o.pakoDeflatePath}),n.addEventListener("message",function(n){!function(n){o.onUploadProgress.call(this,0);var a,t=new FormData;for(var i in t.append("files_count",n.length),n)t.append("file_"+i,n[i].content),t.append("file_"+i+"_infos",JSON.stringify({name:n[i].filename,orig_size:n[i].orig_size,compressed:n[i].compressed}));a=o.url instanceof Function?o.url():o.url,e.ajax({type:"POST",url:a,data:t,processData:!1,contentType:!1,cache:!1,timeout:o.timeout,dataType:o.resDataType,xhr:function(){var o=e.ajaxSettings.xhr();return o.upload&&o.upload.addEventListener("progress",s,!1),o},success:function(e){o.onUploadSuccess.call(this,e)},error:function(e){o.onUploadError.call(this,e)}}).always(function(){o.onAjaxComplete.call(),r=!1})}(n.data)},!1),e(document).off("drop").on("drop",function(e){e.preventDefault()}),e(document).off("dragenter").on("dragenter",function(e){e.preventDefault()}),e(document).off("dragleave").on("dragleave",function(e){e.preventDefault()}),e(document).off("dragover").on("dragover",function(e){e.preventDefault()}),a.off("click").on("click",function(e){r&&e.preventDefault()}),a.find("input[type=file]").off("change").on("change",function(o){if(!r){var n=o.target&&o.target.files;n&&n.length&&(l(n),e(this).val(""))}}),a.off("dragenter").on("dragenter",function(e){e.preventDefault(),r||(0===t&&o.onDragEnter.call(),t++)}),a.off("dragleave").on("dragleave",function(e){e.preventDefault(),r||0===--t&&o.onDragLeave.call()}),a.off("drop").on("drop",function(e){if(e.preventDefault(),!r){t>0&&(t=0,o.onDragLeave.call());var n=e.originalEvent&&e.originalEvent.dataTransfer;n&&n.files&&n.files.length&&l(n.files)}})}}(jQuery);
