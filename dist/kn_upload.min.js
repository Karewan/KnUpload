/**
 * KnUpload v5.0.1 (2023-12-23 16:23:52 +0100)
 * Copyright (c) 2019-2023 Florent VIALATTE
 * Released under the MIT license
 */

'use strict';const KnUpload={VERSION:'5.0.1'};Element.prototype.KnUpload=function(e){let n=this,t=n.querySelector('input[type=file]'),o=0,r=!1,a=null;if(!(e=Object.assign({url:null,data:{},responseType:'json',headers:{},csrf:null,csrfHeader:'X-CSRF',withCredentials:!1,basicAuth:null,bearerAuthToken:null,maxFiles:1,timeout:0,maxFilesSize:20971520,killDocumentDad:!1,onDragEnter:null,onDragLeave:null,onNewFiles:null,onFileSizeError:null,onTooManyFiles:null,onBeforeUpload:null,onUploadProgress:null,onUploadComplete:null,onUploadSuccess:null,onUploadError:null,onAjaxComplete:null},e||{})).url)throw'URL is mandatory';function l(e){r&&(e.stopPropagation(),e.preventDefault())}function s(e){r||e.target&&e.target.files&&e.target.files.length&&(f(e.target.files),this.value='')}function i(n){n.stopPropagation(),n.preventDefault(),r||(o>0&&(o=0,e.onDragLeave&&e.onDragLeave.call()),n.dataTransfer&&n.dataTransfer.files&&n.dataTransfer.files.length&&f(n.dataTransfer.files))}function d(n){n.stopPropagation(),n.preventDefault(),r||(e.onDragEnter&&0==o&&e.onDragEnter.call(),o++)}function u(e){e.stopPropagation(),e.preventDefault()}function c(n){n.stopPropagation(),n.preventDefault(),r||(o--,e.onDragLeave&&0==o&&e.onDragLeave.call())}function p(e){return e.stopPropagation(),e.preventDefault(),!1}function f(n){if(r=!0,e.onNewFiles&&e.onNewFiles.call(this,n),n.length>e.maxFiles)return e.onTooManyFiles&&e.onTooManyFiles.call(),void(r=!1);const t=[];let o=0;for(const a in n)if('object'==typeof n[a]){if(o+=n[a].size,n[a].size>e.maxFilesSize||o>e.maxFilesSize)return e.onFileSizeError&&e.onFileSizeError.call(),void(r=!1);t.push(n[a])}e.onBeforeUpload&&e.onBeforeUpload.call();const a=[];for(const n in t){const o=new FileReader;o.onload=e=>{a.push({name:t[n].name,content:new Blob([e.target.result])}),a.length==t.length&&r&&v(a)},o.onerror=n=>{e.onUploadError&&e.onUploadError.call(this,n),r=!1},o.readAsArrayBuffer(t[n])}}function v(n){null!=a&&a.abort(),e.onUploadProgress&&e.onUploadProgress.call(this,0);let t=new FormData;t.append('nb_files',n.length),n.forEach(((e,n)=>{t.append('file_'+n,e.content),t.append('file_'+n+'_name',e.name)}));for(const[n,o]of Object.entries('function'==typeof e.data?e.data():e.data))t.append(n,'function'==typeof o?o():o);for(const[n,t]of Object.entries(e.headers))e.headers[n]='function'==typeof t?t():t;a=KnHttp.postRaw('function'==typeof e.url?e.url():e.url,t,{upload:!0,timeout:e.timeout,responseType:e.responseType,headers:e.headers,csrf:e.csrf,csrfHeader:e.csrfHeader,withCredentials:e.withCredentials,basicAuth:e.basicAuth,bearerAuthToken:e.bearerAuthToken}).onProgress((n=>{-1!=n&&(e.onUploadProgress&&e.onUploadProgress.call(this,n),n>=100&&e.onUploadComplete&&e.onUploadComplete.call())})).onSuccess(((n,t)=>{e.onUploadSuccess&&e.onUploadSuccess.call(this,n,t)})).onError(((n,t)=>{n!=KnHttp.CANCELED_ERROR&&e.onUploadError&&e.onUploadError.call(this,n,t)})).onEnd((()=>{e.onAjaxComplete&&e.onAjaxComplete.call(),r=!1}))}return e.maxFiles>1?t.setAttribute('multiple',''):t.removeAttribute('multiple'),n.addEventListener('click',l),t.addEventListener('change',s),n.addEventListener('drop',i),n.addEventListener('dragenter',d),n.addEventListener('dragover',u),n.addEventListener('dragleave',c),e.killDocumentDad&&(document.addEventListener('drag',p),document.addEventListener('dragstart',p),document.addEventListener('dragend',p),document.addEventListener('dragenter',p),document.addEventListener('dragover',p),document.addEventListener('dragleave',p),document.addEventListener('drop',p)),{opt:e,uploadInProgress:r,cancel:function(){r=!1,null!=a&&a.abort()},destroy:function(){n.removeEventListener('click',l),t.removeEventListener('change',s),n.removeEventListener('drop',i),n.removeEventListener('dragenter',d),n.removeEventListener('dragover',u),n.removeEventListener('dragleave',c),e.killDocumentDad&&(document.removeEventListener('drag',p),document.removeEventListener('dragstart',p),document.removeEventListener('dragend',p),document.removeEventListener('dragenter',p),document.removeEventListener('dragover',p),document.removeEventListener('dragleave',p),document.removeEventListener('drop',p)),null!=a&&a.abort()}}};