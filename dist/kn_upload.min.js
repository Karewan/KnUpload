/**
 * KnUpload v4.0.0 (2023-01-07 19:36:38 +0100)
 * Copyright (c) 2019-2023 Florent VIALATTE
 * Released under the MIT license
 */
'use strict';const KnUpload={VERSION:'4.0.0'};Element.prototype.KnUpload=function(e){let n=this,o=n.querySelector('input[type=file]'),t=0,r=!1,a=null;if(e||(e={}),!e.url)throw'URL is mandatory';function l(e){r&&(e.stopPropagation(),e.preventDefault())}function d(e){r||e.target&&e.target.files&&e.target.files.length&&(v(e.target.files),this.value='')}function s(n){n.stopPropagation(),n.preventDefault(),r||(t>0&&(t=0,e.onDragLeave&&e.onDragLeave.call()),n.dataTransfer&&n.dataTransfer.files&&n.dataTransfer.files.length&&v(n.dataTransfer.files))}function i(n){n.stopPropagation(),n.preventDefault(),r||(e.onDragEnter&&0==t&&e.onDragEnter.call(),t++)}function p(e){e.stopPropagation(),e.preventDefault()}function u(n){n.stopPropagation(),n.preventDefault(),r||(t--,e.onDragLeave&&0==t&&e.onDragLeave.call())}function c(e){return e.stopPropagation(),e.preventDefault(),!1}function v(n){if(r=!0,e.onNewFiles&&e.onNewFiles.call(this,n),n.length>e.max_files)return e.onTooManyFiles&&e.onTooManyFiles.call(),void(r=!1);const o=[];let t=0;for(const a in n)if('object'==typeof n[a]){if(t+=n[a].size,n[a].size>e.max_files_size||t>e.max_files_size)return e.onFileSizeError&&e.onFileSizeError.call(),void(r=!1);o.push(n[a])}e.onBeforeUpload&&e.onBeforeUpload.call();const a=[];for(const n in o){const t=new FileReader;t.onload=e=>{a.push({name:o[n].name,content:new Blob([e.target.result])}),a.length==o.length&&r&&f(a)},t.onerror=n=>{e.onUploadError&&e.onUploadError.call(this,n),r=!1},t.readAsArrayBuffer(o[n])}}function f(n){null!=a&&a.abort(),e.onUploadProgress&&e.onUploadProgress.call(this,0);let o=new FormData;o.append('nb_files',n.length),n.forEach(((e,n)=>{o.append('file_'+n,e.content),o.append('file_'+n+'_name',e.name)}));for(const[n,t]of Object.entries(e.data))o.append(n,'function'==typeof t?t():t);for(const[n,o]of Object.entries(e.headers))e.headers[n]='function'==typeof o?o():o;a=KnHttp.postRaw(e.url,o,{upload:!0,timeout:e.timeout,headers:e.headers}).onProgress((n=>{-1!=n&&(e.onUploadProgress&&e.onUploadProgress.call(this,n),n>=100&&e.onUploadComplete&&e.onUploadComplete.call())})).onSuccess(((n,o)=>{e.onUploadSuccess&&e.onUploadSuccess.call(this,n,o)})).onError(((n,o)=>{n!=KnHttp.CANCELED_ERROR&&e.onUploadError&&e.onUploadError.call(this,n,o)})).onEnd((()=>{e.onAjaxComplete&&e.onAjaxComplete.call(),r=!1}))}return e.data||(e.data={}),e.headers||(e.headers={}),e.max_files||(e.max_files=1),e.timeout||(e.timeout=0),e.max_files_size||(e.max_files_size=20971520),e.kill_document_dad||(e.kill_document_dad=!1),e.onDragEnter||(e.onDragEnter=null),e.onDragLeave||(e.onDragLeave=null),e.onNewFiles||(e.onNewFiles=null),e.onFileSizeError||(e.onFileSizeError=null),e.onTooManyFiles||(e.onTooManyFiles=null),e.onBeforeUpload||(e.onBeforeUpload=null),e.onUploadProgress||(e.onUploadProgress=null),e.onUploadComplete||(e.onUploadComplete=null),e.onUploadSuccess||(e.onUploadSuccess=null),e.onUploadError||(e.onUploadError=null),e.onAjaxComplete||(e.onAjaxComplete=null),e.max_files>1?o.setAttribute('multiple',''):o.removeAttribute('multiple'),n.addEventListener('click',l),o.addEventListener('change',d),n.addEventListener('drop',s),n.addEventListener('dragenter',i),n.addEventListener('dragover',p),n.addEventListener('dragleave',u),e.kill_document_dad&&(document.addEventListener('drag',c),document.addEventListener('dragstart',c),document.addEventListener('dragend',c),document.addEventListener('dragenter',c),document.addEventListener('dragover',c),document.addEventListener('dragleave',c),document.addEventListener('drop',c)),{opt:e,upload_in_progress:r,cancel:function(){r=!1,null!=a&&a.abort()},destroy:function(){n.removeEventListener('click',l),o.removeEventListener('change',d),n.removeEventListener('drop',s),n.removeEventListener('dragenter',i),n.removeEventListener('dragover',p),n.removeEventListener('dragleave',u),e.kill_document_dad&&(document.removeEventListener('drag',c),document.removeEventListener('dragstart',c),document.removeEventListener('dragend',c),document.removeEventListener('dragenter',c),document.removeEventListener('dragover',c),document.removeEventListener('dragleave',c),document.removeEventListener('drop',c)),null!=a&&a.abort()}}};
