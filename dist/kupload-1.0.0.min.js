/**
 * kupload v1.0.0 - Copyright (c) 2019 Nogema Technology SAS
 * Released under proprietary license, all rights reserved
 */
"use strict";!function(e){e.fn.kupload=function(o){var n,a=e(this),t=0,i=!1;if(o||(o={}),!o.url)throw"upload URL is mandatory";if(o.multiple||(o.multiple=!1),o.maxfiles||(o.maxfiles=3),o.compress||(o.compress=!1),o.compress&&!o.pakoDeflatePath)throw"pakoDeflatePath is mandatory if compress";o.timeout||(o.timeout=0),o.maxfilesize||(o.maxfilesize=20971520),o.resDataType||(o.resDataType=null),o.onDragEnter||(o.onDragEnter=function(){}),o.onDragLeave||(o.onDragLeave=function(){}),o.onNewFiles||(o.onNewFiles=function(){}),o.onFileSizeError||(o.onFileSizeError=function(){}),o.onTooManyFiles||(o.onTooManyFiles=function(){}),o.onBeforeUpload||(o.onBeforeUpload=function(){}),o.onUploadProgress||(o.onUploadProgress=function(){}),o.onUploadComplete||(o.onUploadComplete=function(){}),o.onUploadSuccess||(o.onUploadSuccess=function(){}),o.onUploadError||(o.onUploadError=function(){}),o.onAjaxComplete||(o.onAjaxComplete=function(){}),this.upInProgress=function(){return i};var r,l=function(e){if(i=!0,e.length>o.maxfiles)return o.onTooManyFiles.call(),void(i=!1);o.onNewFiles.call(this,e);var a=[],t=0;for(var r in e)if("object"==typeof e[r]){var l=e[r];if(t+=l.size,l.size>o.maxfilesize||t>o.maxfilesize)return o.onFileSizeError.call(),void(i=!1);if(a.push(e[r]),!o.multiple)break}o.onBeforeUpload.call(),n.postMessage({compress:o.compress,files:a})},s=function(e){if(void 0!==e&&e.lengthComputable){var n=Math.round(100*e.loaded/e.total);o.onUploadProgress.call(this,n),n>=100&&o.onUploadComplete.call()}},f="'use strict';var act=['','text/css','text/javascript','text/xml','text/plain','text/html','text/x-component','application/javascript','application/x-javascript','application/json','application/manifest+json','application/xml','application/xhtml+xml','application/rss+xml','application/atom+xml','application/rdf+xml','application/vnd.ms-fontobject','font/truetype','font/opentype','font/ttf','font/eot','font/otf','application/x-font-ttf','application/x-font-opentype','application/x-font-truetype','image/svg+xml','image/x-icon','image/vnd.microsoft.icon'];self.addEventListener('message',function(e){if(e.data.pakoDeflatePath){importScripts(e.data.pakoDeflatePath);return}var files=e.data.files;var compress=e.data.compress;var final_res=[];for(var i in files){var can_compress=!1;var file=files[i];if(compress&&file.size>100&&act.indexOf(file.type)>-1)can_compress=!0;var content;if(can_compress)content=pako.gzip((new FileReaderSync()).readAsArrayBuffer(file),{level:1});else content=(new FileReaderSync()).readAsArrayBuffer(file);final_res.push({filename:file.name,orig_size:file.size,compressed:can_compress,content:new Blob([content])})}self.postMessage(final_res)},!1)";try{r=new Blob([f],{type:"application/javascript"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,(r=new BlobBuilder).append(f),r=r.getBlob()}n=new Worker((window.URL||window.webkitURL).createObjectURL(r)),o.compress&&n.postMessage({pakoDeflatePath:o.pakoDeflatePath}),n.addEventListener("message",function(n){!function(n){o.onUploadProgress.call(this,0);var a=new FormData;for(var t in a.append("files_count",n.length),n)a.append("file_"+t,n[t].content),a.append("file_"+t+"_infos",JSON.stringify({name:n[t].filename,orig_size:n[t].orig_size,compressed:n[t].compressed}));e.ajax({type:"POST",url:o.url,data:a,processData:!1,contentType:!1,cache:!1,timeout:o.timeout,dataType:o.resDataType,xhr:function(){var o=e.ajaxSettings.xhr();return o.upload&&o.upload.addEventListener("progress",s,!1),o},success:function(e){o.onUploadSuccess.call(this,e)},error:function(e){o.onUploadError.call(this,e)}}).always(function(){o.onAjaxComplete.call(),i=!1})}(n.data)},!1),e(document).off("drop").on("drop",function(e){e.preventDefault()}),e(document).off("dragenter").on("dragenter",function(e){e.preventDefault()}),e(document).off("dragleave").on("dragleave",function(e){e.preventDefault()}),e(document).off("dragover").on("dragover",function(e){e.preventDefault()}),a.off("click").on("click",function(e){i&&e.preventDefault()}),a.find("input[type=file]").off("change").on("change",function(o){if(!i){var n=o.target&&o.target.files;n&&n.length&&(l(n),e(this).val(""))}}),a.off("dragenter").on("dragenter",function(e){e.preventDefault(),i||(0===t&&o.onDragEnter.call(),t++)}),a.off("dragleave").on("dragleave",function(e){e.preventDefault(),i||0===--t&&o.onDragLeave.call()}),a.off("drop").on("drop",function(e){if(e.preventDefault(),!i){t>0&&(t=0,o.onDragLeave.call());var n=e.originalEvent&&e.originalEvent.dataTransfer;n&&n.files&&n.files.length&&l(n.files)}})}}(jQuery);
